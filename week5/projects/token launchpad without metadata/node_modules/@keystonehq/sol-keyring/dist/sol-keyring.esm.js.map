{"version":3,"file":"sol-keyring.esm.js","sources":["../src/DefaultInteractionProvider.ts","../src/BaseKeyring.ts","../src/DefaultKeyring.ts"],"sourcesContent":["import { SolSignature, SolSignRequest } from \"@keystonehq/bc-ur-registry-sol\";\nimport { InteractionProvider } from \"./InteractionProvider\";\nimport sdk, { PlayStatus, ReadStatus, SupportedResult } from \"@keystonehq/sdk\";\nimport { CryptoMultiAccounts } from \"@keystonehq/bc-ur-registry\";\n\nexport class DefaultInteractionProvider implements InteractionProvider {\n  private static instance;\n  private keystoneSDK = undefined;\n\n  constructor() {\n    if (DefaultInteractionProvider.instance) {\n      return DefaultInteractionProvider.instance;\n    }\n    sdk.bootstrap();\n    this.keystoneSDK = sdk.getSdk();\n    DefaultInteractionProvider.instance = this;\n  }\n\n  public readCryptoMultiAccounts = async () => {\n    const decodedResult = await this.keystoneSDK.read(\n      [SupportedResult.UR_CRYPTO_MULTI_ACCOUNTS],\n      {\n        title: \"Sync Keystone\",\n        description: \"Please scan the QR code displayed on your Keystone\",\n        renderInitial: {\n          walletMode: \"Solflare\",\n          link: \"https://keyst.one/defi\",\n        },\n        URTypeErrorMessage:\n          \"The scanned QR code is not the sync code from the Keystone hardware wallet. Please verify the code and try again\",\n      }\n    );\n    if (decodedResult.status === ReadStatus.success) {\n      const { result } = decodedResult;\n      return CryptoMultiAccounts.fromCBOR(result.cbor);\n    } else {\n      throw new Error(\"Reading canceled\");\n    }\n  };\n\n  public requestSignature = async (\n    solSignRequest: SolSignRequest,\n    requestTitle?: string,\n    requestDescription?: string\n  ) => {\n    const status = await this.keystoneSDK.play(solSignRequest.toUR(), {\n      hasNext: true,\n      title: requestTitle,\n      description: requestDescription,\n      maxFragmentLength: 400,\n    });\n    if (status === PlayStatus.canceled)\n      throw new Error(\"#ktek_error[play-cancel]: play canceled\");\n    const result = await this.keystoneSDK.read(\n      [SupportedResult.UR_SOL_SIGNATURE],\n      {\n        title: \"Scan Keystone\",\n        description: \"Please scan the QR code displayed on your Keystone\",\n      }\n    );\n    if (result.status === ReadStatus.canceled) {\n      throw new Error(\"#ktek_error[read-cancel]: read signature canceled\");\n    } else {\n      return SolSignature.fromCBOR(result.result.cbor);\n    }\n  };\n}\n","import bs58 from \"bs58\";\nimport * as uuid from \"uuid\";\nimport { Message, Transaction } from \"@solana/web3.js\";\nimport { InteractionProvider } from \"./InteractionProvider\";\nimport { CryptoMultiAccounts } from \"@keystonehq/bc-ur-registry\";\nimport { SolSignRequest, SignType } from \"@keystonehq/bc-ur-registry-sol\";\n\nconst keyringType = \"QR Hardware Wallet Device\";\n\nexport interface HDKey {\n  hdPath: string;\n  pubKey: string;\n  index: number;\n}\n\ninterface KeyringInitData {\n  xfp: string;\n  keys: HDKey[];\n  name?: string;\n  device?: string;\n}\n\nexport class BaseKeyring {\n  getInteraction = (): InteractionProvider => {\n    throw new Error(\n      \"KeystoneError#invalid_extends: method getInteraction not implemented, please extend BaseKeyring by overwriting this method.\"\n    );\n  };\n  static type = keyringType;\n  protected xfp: string;\n  protected type = keyringType;\n  protected initialized: boolean;\n  protected keys: HDKey[];\n  protected name: string;\n  protected device: string;\n\n  constructor() {\n    //common props\n    this.keys = [];\n    this.name = \"QR Hardware\";\n    this.initialized = false;\n    this.device = \"\";\n    this.xfp = \"\";\n  }\n\n  protected requestSignature = async (\n    _requestId: string,\n    signRequest: SolSignRequest,\n    requestTitle?: string,\n    requestDescription?: string\n  ): Promise<Buffer> => {\n    const solSignature = await this.getInteraction().requestSignature(\n      signRequest,\n      requestTitle,\n      requestDescription\n    );\n    const requestIdBuffer = solSignature.getRequestId();\n    const signature = solSignature.getSignature();\n    if (requestIdBuffer) {\n      const requestId = uuid.stringify(requestIdBuffer);\n      if (requestId !== _requestId) {\n        throw new Error(\n          \"KeystoneError#invalid_data: read signature error: mismatched requestId\"\n        );\n      }\n    }\n    return signature;\n  };\n\n  //initial read\n  async readKeyring(): Promise<void> {\n    const result = await this.getInteraction().readCryptoMultiAccounts();\n    this.syncKeyring(result);\n  }\n\n  public syncKeyring(data: CryptoMultiAccounts): void {\n    const keys = data.getKeys();\n    this.device = data.getDevice();\n    this.xfp = data\n      .getKeys()[0]\n      .getOrigin()\n      .getSourceFingerprint()\n      ?.toString(\"hex\");\n    this.name = data.getKeys()[0].getName();\n    this.keys = keys.map((each, index) => ({\n      hdPath: each.getOrigin().getPath(),\n      pubKey: bs58.encode(each.getKey()),\n      index,\n    }));\n    this.initialized = true;\n  }\n\n  public syncKeyringData({\n    xfp,\n    keys,\n    name = \"QR Hardware\",\n    device,\n  }: KeyringInitData): void {\n    this.xfp = xfp;\n    this.name = name;\n    this.keys = keys;\n    this.device = device;\n    this.initialized = true;\n  }\n\n  public getName = (): string => {\n    return this.name;\n  };\n\n  getAccounts() {\n    if (!this.initialized) {\n      return [];\n    }\n    return this.keys;\n  }\n\n  async signTransaction(pubKey: string, txHex: Uint8Array): Promise<Uint8Array> {\n    const signature = await this._getSignature(\n      pubKey,\n      Buffer.from(txHex),\n      SignType.Transaction\n    );\n    return signature;\n  }\n\n  async signMessage(\n    pubKey: string,\n    messageHex: Uint8Array\n  ): Promise<Uint8Array> {\n    return await this._getSignature(\n      pubKey,\n      Buffer.from(messageHex),\n      SignType.Message\n    );\n  }\n\n  async createSignature(\n    pubKey: string,\n    messageHex: Uint8Array\n  ): Promise<Uint8Array> {\n    try {\n      const messageInstance = Message.from(messageHex);\n      const transaction = Transaction.populate(messageInstance, []);\n      if (transaction) {\n        return this._getSignature(\n          pubKey,\n          Buffer.from(messageHex),\n          SignType.Transaction\n        );\n      }\n    } catch (e) {\n      console.error(e);\n    }\n    return this.signMessage(pubKey, messageHex);\n  }\n\n  async _getSignature(\n    pubKey: string,\n    messageHex: Buffer,\n    signType\n  ): Promise<Buffer> {\n    const requestId = uuid.v4();\n    const account = this.getAccounts().find(\n      (account) => account.pubKey == pubKey\n    );\n    const solSignRequest = SolSignRequest.constructSOLRequest(\n      messageHex,\n      account.hdPath,\n      this.xfp,\n      signType,\n      requestId\n    );\n    return this.requestSignature(\n      requestId,\n      solSignRequest,\n      \"Scan with your Keystone\",\n      'After your Keystone has signed this message, click on \"Scan Keystone\" to receive the signature'\n    );\n  }\n}\n","import { DefaultInteractionProvider } from \"./DefaultInteractionProvider\";\nimport { BaseKeyring } from \"./BaseKeyring\";\n\nexport class DefaultKeyring extends BaseKeyring {\n  static type = BaseKeyring.type;\n\n  static getEmptyKeyring(): DefaultKeyring {\n    return new DefaultKeyring();\n  }\n\n  constructor() {\n    super();\n  }\n\n  getInteraction = () => {\n    return new DefaultInteractionProvider();\n  };\n}\n"],"names":["DefaultInteractionProvider","constructor","undefined","decodedResult","keystoneSDK","read","SupportedResult","UR_CRYPTO_MULTI_ACCOUNTS","title","description","renderInitial","walletMode","link","URTypeErrorMessage","status","ReadStatus","success","result","CryptoMultiAccounts","fromCBOR","cbor","Error","solSignRequest","requestTitle","requestDescription","play","toUR","hasNext","maxFragmentLength","PlayStatus","canceled","UR_SOL_SIGNATURE","SolSignature","instance","sdk","bootstrap","getSdk","keyringType","BaseKeyring","_requestId","signRequest","solSignature","getInteraction","requestSignature","requestIdBuffer","getRequestId","signature","getSignature","requestId","uuid","name","keys","initialized","device","xfp","readKeyring","readCryptoMultiAccounts","syncKeyring","data","getKeys","getDevice","_data$getKeys$0$getOr","getOrigin","getSourceFingerprint","toString","getName","map","each","index","hdPath","getPath","pubKey","bs58","encode","getKey","syncKeyringData","getAccounts","signTransaction","txHex","_getSignature","Buffer","from","SignType","Transaction","signMessage","messageHex","Message","createSignature","messageInstance","transaction","populate","e","console","error","signType","account","find","SolSignRequest","constructSOLRequest","DefaultKeyring","getEmptyKeyring","type"],"mappings":"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"}